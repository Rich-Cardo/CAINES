{% include 'header.html' %}



{% with messages = get_flashed_messages() %}
  {% if messages %}
    <div class="alert alert-info  " style="margin-top: 10px; margin-right: 5px;">
      {{ messages[0] }}
    </div>
  {% endif %}
{% endwith %}

<h1 class="text-center titulo-vista">Citas</h1>

<div class="container" style="padding-top: 10px;">
    <div class="row align-items-center">
      <div class="col-lg-6 col-md-6 col-sm-8 mb-3">
        <div class="input-group">
          <input id="searchInput" type="text" class="form-control" placeholder="Buscar citas..." aria-label="Buscar citas..." aria-describedby="basic-addon2">
          <div class="input-group-append">
            <span class="input-group-text" id="basic-addon2"><i class="fa fa-search"></i></span>
          </div>
        </div>
      </div>
      <div class="col-lg-3 col-md-3 col-sm-12 mb-3">
        <!-- <a href="javascript:void(0);" onclick="guardarPDF()" class="btn btn-warning btn-block">
          <i class="fa fa-print" style="margin-right: 5px;"></i> Exportar a PDF
        </a> -->
      </div>      
    </div>
  </div>
        
<button onclick="Buscar()" style="display: none;" class="btn btn-info">Buscar</button>
        
<div id="myTable" class="table-responsive">
  <table id="tabla_citas" class="table table-light table-bordered border-secondary rounded" cellspacing="0">
    <thead class="thead-light text-center">
      <tr>
                        <th><input type="checkbox" id="selectAll" style="display: none;"></th>
                        <th>ID</th>
                        <th>Cedula</th>
                        <th>Nombre</th>
                        <th>Apellido</th>
                        <th>Solicitud</th>
                        <th>Estado</th>
                        <th>Fecha</th>
                        <th>Hora</th>
                        <th>Acciones</th>

                    </tr>
                </thead>
                <tbody>

                    {% for citas in citas %}
                    
                    <tr class="text-center">
                      <td><input type="checkbox" class="rowCheckbox" value="{{ citas[0] }}"></td>
                        <!-- ID Cita -->
                        <td>{{citas[0] }}</td>
                        <!-- cedula -->
                        <td>{{citas[8] }}</td>
                        <!-- nombre -->
                        <td>{{citas[6] }}</td>
                        <!-- apellido -->
                        <td>{{citas[7] }}</td>
                        <!-- fecha -->
                        <td>{{citas[2].strftime('%d/%m/%Y') }}</td>
                        <!-- estado -->
                        <td>{{citas[3].upper() }}</td>
                        <!-- Fecha -->
                        {% if citas[4] == '0' %}
                        <td>PENDIENTE</td>
                        {% elif citas[4] %}
                            <td>{{ citas[4] }}</td>
                        {% else %}
                            <td>PENDIENTE</td>
                        {% endif %}

                        <!-- Hora -->
                        {% if citas[5] == '0' %}
                        <td>PENDIENTE</td>
                        {% elif citas[5] %}
                            <td>{{ citas[5] }}</td>
                        {% else %}
                            <td>PENDIENTE</td>
                        {% endif %}

                        



                        <td>
                            <div class="btn-group">
                              <a class="btn btn-success" href="#" data-toggle="modal" data-target="#myModal{{ citas[0] }}" style="border-radius: 10px; margin-right: 5px;">
                                <i class="fa fa-eye"></i>
                              </a>
                              <a class="btn btn-danger" href="javascript:void(0);" onclick="eliminarCita('{{ citas[0] }}')" style="border-radius: 10px; margin-right: 5px;">
                                <i class="fa fa-trash"></i>
                              </a>
                   
                            </div>           
                        </td>

                    </tr>
                    
                    {% endfor %}

                
                </tbody>



            </table>

           </div>  

           <button id="deleteSelected" class="btn btn-danger" style="display: none; width: 30%; margin-left:5%; margin-top: 1%">Eliminar Seleccionados</button>


            <!-- Codigo para mostrar el modal con los datos del citas -->

            {% for citas in citas %}


            <div class="modal fade" id="myModal{{citas[0]}}" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
              <div class="modal-dialog" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h4 class="modal-title" id="myModalLabel">Cita</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                  </div>
                  <div class="modal-body">

                    <form id="formCita" class="" method="post" action="/actualizar_cita" enctype="multipart/form-data">

                      <div class="row" style="margin-bottom: 10px;">
                        <!-- <label for="floatingInput" class="col-3">IdNino</label> -->
                        <input id="txtId" class="form-control col-8" type="hidden" name="txtId" value="{{citas[0]}}" readonly>
                      </div>

                      <div class="row" style="margin-bottom: 10px;">
                        <label for="floatingInput" class="col-3">Solicitud</label>
                        <input id="txtFecha" class="form-control col-8" name="txtFecha" value = {{citas[2]}} readonly>
                      </div>


        
                      <div class="row" style="margin-bottom: 10px;">
                        <label for="floatingInput" class="col-3">Cédula</label>
                        <input id="txtCedula" class="form-control col-8" name="txtCedula" value = {{citas[8]}} readonly>
                      </div>

                      <div class="row" style="margin-bottom: 10px;">
                        <label for="floatingInput" class="col-3">Nombre</label>
                        <input id="txtNombre" class="form-control col-8" name="txtNombre" value = {{citas[6]}} readonly>
                      </div>
        
                      <div class="row" style="margin-bottom: 10px;">
                        <label for="floatingInput" class="col-3">Apellido</label>
                        <input id="txtApellido" class="form-control col-8" name="txtApellido" value = {{citas[7]}} readonly>
                      </div>

        
                      <div class="row" style="margin-bottom: 10px;">
                        <label for="floatingInput" class="col-3">Telefono</label>
                        <input id="txtTelefono" class="form-control col-8" name="txtTelefono" value = {{citas[9]}} readonly>
                      </div> 
        
                      <div class="row" style="margin-bottom: 10px;">
                        <label for="floatingInput" class="col-3">Estado</label>
                        <input id="txtEstado" class="form-control col-8" name="txtEstado" value = {{citas[3]}} readonly>
                      </div>

                      <div class="row" style="margin-bottom: 10px;">
                        <label for="floatingInput" class="col-3">Nueva Fecha</label>
                        <input id="txtNuevaFecha" class="form-control col-8" name="txtNuevaFecha" type="date">
                      </div> 
        
                      <div class="row" style="margin-bottom: 10px;">
                        <label for="floatingInput" class="col-3">Hora</label>
                        <select id="txtHora" class="form-control col-8" name="txtHora" required>
        
                          <option value="9:00 am">9:00 am</option> 
                          <option value="9:30 am">9:30 am</option> 
                          <option value="10:00 am">10:00 am</option>
                          <option value="10:30 am">10:30 am</option>
                          <option value="11:00 am">11:00 am</option>
                          <option value="11:30 am">11:30 am</option>
                          <option value="12:00 pm">12:00 pm</option>
                          <option value="12:30 pm">12:30 pm</option>
                          <option value="1:00 pm">1:00 pm</option>
                          <option value="1:30 pm">1:30 pm</option>
                          <option value="2:00 pm">2:00 pm</option>
                          <option value="2:30 pm">2:30 pm</option>
                          <option value="3:00 pm">3:00 pm</option>
                          <option value="3:30 pm">3:30 pm</option>
                          <option value="4:00 pm">4:00 pm</option>
                          <option value="4:30 pm">4:30 pm</option>
                          <option value="5:00 pm">5:00 pm</option>
        
                        </select>
                      </div>

                      <button type="submit" id="btnAprobar" class="btn btn-success">Aprobar</button>
                      <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>

                    </form>

                  </div>

                  <div class="modal-footer">

                  </div>
                </div>
              </div>
            </div>
            
            {% endfor %}
        




  



    
        







    
    </div>

  <script>

      // Agregar el evento change al input de búsqueda
  document.getElementById("searchInput").addEventListener("input", Buscar);

document.addEventListener('DOMContentLoaded', function() {
  const selectAllCheckbox = document.getElementById('selectAll');
  let rowCheckboxes = document.querySelectorAll('.rowCheckbox');
  const deleteButton = document.getElementById('deleteSelected');
  const sendButton = document.getElementById('sendSelected');
  const undoButton = document.getElementById('undoButton');
  const countdown = document.getElementById('countdown');
  let countdownInterval;

  function updateDeleteButtonVisibility() {
    const anyChecked = Array.from(rowCheckboxes).some(checkbox => checkbox.checked);
    deleteButton.style.display = anyChecked ? 'block' : 'none';
  }

  selectAllCheckbox.addEventListener('change', function() {
    rowCheckboxes.forEach(checkbox => {
      checkbox.checked = selectAllCheckbox.checked;
    });
    updateDeleteButtonVisibility();
  });

  rowCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      updateDeleteButtonVisibility();
    });
  });

  deleteButton.addEventListener('click', function() {
  const checkboxes = document.querySelectorAll('.rowCheckbox:checked');
  const ids = Array.from(checkboxes).map(checkbox => checkbox.value);

  if (ids.length === 0) {
    Swal.fire({
      title: 'Atención',
      text: 'Por favor, seleccione al menos una fila para eliminar.',
      icon: 'warning',
      confirmButtonColor: '#3085d6',
    });
    return;
  }

  Swal.fire({
    title: '¡ATENCIÓN!',
    text: '¿Está seguro de que desea eliminar las citas seleccionadas?',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#3085d6',
    cancelButtonColor: '#d33',
    confirmButtonText: 'Sí, eliminar',
    cancelButtonText: 'Cancelar'
  }).then((result) => {
    if (result.isConfirmed) {
      fetch('/eliminar_citas', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ ids: ids })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Error al eliminar las citas seleccionadas.');
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          checkboxes.forEach(checkbox => {
            const row = checkbox.closest('tr');
            row.remove();
          });

          rowCheckboxes = document.querySelectorAll('.rowCheckbox');
          updateDeleteButtonVisibility();

          Swal.fire({
            title: 'Eliminado',
            text: 'Las citas seleccionadas han sido eliminados exitosamente.',
            icon: 'success',
            confirmButtonColor: '#3085d6',
          });

        } else {
          Swal.fire({
            title: 'Error',
            text: 'Error al eliminar las filas seleccionadas.',
            icon: 'error',
            confirmButtonColor: '#3085d6',
          });
        }
      })
      .catch(error => {
        console.error('Error:', error);
        Swal.fire({
          title: 'Error',
          text: 'Error al eliminar las filas seleccionadas.',
          icon: 'error',
          confirmButtonColor: '#3085d6',
        });
      });
    }
  });
});

    window.eliminarCita = function(id) {
    Swal.fire({
      title: '¡ATENCIÓN!',
      text: '¿Está seguro de que desea eliminar la cita?',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Sí, eliminar',
      cancelButtonText: 'Cancelar'
    }).then((result) => {
      if (result.isConfirmed) {
        fetch('/eliminar_citas', {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ ids: [id] })
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('Error al eliminar la cita.');
          }
          return response.json();
        })
        .then(data => {
          if (data.success) {
            const row = document.querySelector(`.rowCheckbox[value="${id}"]`).closest('tr');
            row.remove();

            rowCheckboxes = document.querySelectorAll('.rowCheckbox');
            updateDeleteButtonVisibility();

            Swal.fire({
              title: 'Eliminado',
              text: 'La cita ha sido eliminada exitosamente.',
              icon: 'success',
              confirmButtonColor: '#3085d6',
            });

          } else {
            Swal.fire({
              title: 'Error',
              text: 'Error al eliminar el niño.',
              icon: 'error',
              confirmButtonColor: '#3085d6',
            });
          }
        })
        .catch(error => {
          console.error('Error:', error);
          Swal.fire({
            title: 'Error',
            text: 'Error al eliminar el niño.',
            icon: 'error',
            confirmButtonColor: '#3085d6',
          });
        });
      }
    });
  };

 
});

    

    // Codigo para que el input fecha salga con la fecha actual
    var campoFecha = document.getElementById("txtNuevaFecha");

    // Obtener la fecha actual en el formato YYYY-MM-DD
    var fechaActual = new Date().toISOString().slice(0, 10);

    // Asignar la fecha actual al campo de fecha
    campoFecha.value = fechaActual;

    // Codigo para que el input fecha salga con la fecha actual 
    var campoFecha = document.getElementById("txtNuevaFecha");

    // // Obtener el estado de la cita
    // var estadoCita = document.getElementById("txtEstado").value;
  
    // // Obtener el botón de Aprobar
    // var btnAprobar = document.getElementById("btnAprobar");
  
    // // Si el estado de la cita es APROBADO, deshabilitar el botón
    // if (estadoCita === "aprobado") {
    //   btnAprobar.disabled = true;
    // }

    function Buscar() {
    // Obtener los valores del input de búsqueda y los inputs de fecha
    var input = document.getElementById("searchInput");
    var filter = input.value.toUpperCase();
    var table = document.getElementById("tabla_citas");
    var tr = table.getElementsByTagName("tr");

    // Recorrer todas las filas de la tabla y ocultar aquellas que no coincidan con la búsqueda o el rango de fechas
    for (var i = 1; i < tr.length; i++) {
        var tdArray = tr[i].getElementsByTagName("td");
        var match = false;

        // Verificar si la fila coincide con el filtro de búsqueda
        for (var j = 0; j < tdArray.length; j++) {
            var td = tdArray[j];
            if (td) {
                if (td.innerHTML.toUpperCase().indexOf(filter) > -1) {
                    match = true;
                    break;
                }
            }
        }

        // Mostrar la fila si coincide con el filtro de búsqueda y el rango de fechas
        if (match) {
            tr[i].style.display = "";
        } else {
            tr[i].style.display = "none";
        }
    }
  }



  </script>







{% include 'footer.html' %}
